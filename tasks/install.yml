---

- name: Add Webtatic repository
  yum:
    name: https://mirror.webtatic.com/yum/el7/webtatic-release.rpm
    state: present
  when: "{{ php_fpm_source_tag is not defined }}"

- name: Install php-fpm
  yum:
    name: "{{ item }}"
    state: present
  with_items: "{{ php_fpm_packages }}"
  when: "{{ php_fpm_source_tag is not defined }}"

- name: Install php from source (install devel dependencies)
  yum:
    name: "{{ item }}"
    state: present
  with_items: "{{ php_fpm_devel_packages }}"
  when: "{{ php_fpm_source_tag is defined }}"

- name: Clone PHP repository
  git:
    repo: "https://github.com/php/php-src.git"
    dest: /tmp/php-src
    version: "{{ php_fpm_source_tag }}"
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (build stage - buildconf)
  command: >
    ./buildconf --force
  args:
    chdir: /tmp/php-src
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (build stage - configure)
  command: >
    ./configure --prefix=/usr
    --sysconfdir=/etc
    --disable-phpdbg
    --enable-bcmath
    --enable-exif
    --enable-filter
    --enable-fpm
    --enable-gd-native-ttf
    --enable-intl
    --enable-mbregex
    --enable-mbstring
    --enable-mysqlnd
    --enable-opcache
    --enable-pcntl
    --enable-simplexml
    --enable-sockets
    --enable-sysvsem
    --enable-sysvshm
    --enable-xmlreader
    --enable-xmlwriter
    --enable-zip
    --with-bz2
    --with-config-file-path=/etc
    --with-config-file-scan-dir=/etc/php.d
    --with-curl
    --with-fpm-group=nginx
    --with-fpm-user=nginx
    --with-freetype-dir
    --with-gd
    --with-gettext
    --with-jpeg-dir
    --with-mcrypt
    --with-mhash
    --with-mysql
    --with-mysqli
    --with-mysql-sock=/var/lib/mysql/mysql.sock
    --with-openssl
    --with-pcre-regex
    --with-pdo-mysql
    --with-pdo-sqlite
    --with-png-dir
    --with-sqlite3
    --with-xmlrpc
    --with-xsl
    --with-zlib
  args:
    chdir: /tmp/php-src
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (build stage - make)
  command: >
    make -j4
  args:
    chdir: /tmp/php-src
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (build stage - make install)
  command: >
    make install
  args:
    chdir: /tmp/php-src
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (uninstall devel dependencies)
  yum:
    name: "{{ item }}"
    state: absent
  with_items: "{{ php_fpm_devel_packages }}"
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (remove source directory)
  file:
    path: /tmp/php-src
    state: absent
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (copy php.ini)
  copy:
    src: files/php.ini
    dest: /etc/php.ini
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (create directory php-fpm conf)
  file:
    path: /etc/php-fpm.d
    state: directory
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (copy php-fpm conf)
  copy:
    src: files/www.conf
    dest: /etc/php-fpm.d/www.conf
  when: "{{ php_fpm_source_tag is defined }}"

- name: Install php from source (remove packages)
  command: >
    yum clean all
  when: "{{ php_fpm_source_tag is defined }}"
 
- name: Set directories permissions
  file:
    path: "{{item}}"
    owner: "{{php_user}}"
    group: "{{php_group}}"
    state: directory
    mode: 0770
  with_items:
    - "{{php_fpm_log_directory}}"
    - "{{php_fpm_session_directory}}"

